# 重複データ管理システム プロジェクト仕様書

## 1. システム概要

コールセンターの受付データ重複管理システム。PostgreSQLデータベースに格納された受付データの重複を検出し、管理するWebアプリケーション。

### 技術スタック
- **バックエンド**: FastAPI (Python)
- **フロントエンド**: Vanilla JavaScript
- **データベース**: PostgreSQL
- **スタイリング**: CSS3
- **アイコン**: Font Awesome 6.4.0

## 2. 主要機能

### 2.1 データ表示・検索機能
- **通常データ表示**: 受付データの一覧表示
- **フィルター機能**:
  - 受付内容キーワード検索
  - 対応状況キーワード検索
  - 進捗フィルター
  - システム種別フィルター
  - 製品フィルター
  - 日付範囲フィルター
- **削除済みデータ表示**: 論理削除されたデータの表示/非表示切り替え

### 2.2 重複検出機能
- **検出タイプ**:
  - 完全一致: 受付内容と対応状況が両方一致
  - 受付内容: 受付内容のみ一致
  - 対応状況: 対応状況のみ一致
- **グループ化表示**: 重複データをグループごとに表示
- **フィルター連携**: 検索条件を適用した上で重複検出

### 2.3 ソート機能
- **複数カラムソート**: 最大3つの優先度でソート可能
- **独立したソート設定**:
  - 検索・フィルター実行用
  - 重複検出用（タイプ別）
- **ソート可能カラム**:
  - ID
  - 受付内容
  - 対応状況
  - 進捗
  - システム種別
  - 製品
  - 受付日時
  - 更新日時

### 2.4 ページング機能
- **自動スクロール**: 
  - スクロール位置に応じて自動的に次のデータを読み込み
  - テーブル設定で有効/無効を切り替え可能
- **手動ページング**:
  - 最初/前/次/最後のページへの移動
  - 現在のページ番号と総ページ数の表示
  - 表示データ範囲の明示（全XX件中 XX-XX件を表示）
- **ページサイズ設定**: 50/100/200/300/500件から選択可能
- **モード別管理**: 通常モードと重複モードで独立したページング

### 2.5 データ管理機能
- **一括選択**: 全選択/全解除
- **個別選択**: チェックボックスによる個別選択
- **論理削除**: 選択したデータの論理削除（receptmoddtフラグ）
- **データ復元**: 削除済みデータの復元

### 2.6 テーブル表示設定
- **カラム表示/非表示**: 各カラムの表示切り替え
- **カラム幅調整**: 各カラムの幅を個別設定
- **設定の永続化**: LocalStorageによる設定保存

### 2.7 統計情報表示
- **通常モード**:
  - 全データ件数
  - 有効データ件数
  - 削除済みデータ件数
  - 表示中件数
  - 選択中件数
- **重複モード**:
  - 重複グループ数
  - 重複データ総数
  - 表示中件数
  - 選択中件数

## 3. 今回の修正内容（2025年9月）

### 3.1 ソート機能の修正
**問題点**: テーブル設定のソート設定が実際の検索・重複検出時に反映されていなかった

**修正内容**:
1. TableManagerにソート設定構造を追加
2. 検索・フィルター用と重複検出用で独立したソート設定
3. 重複検出は3タイプそれぞれに個別設定
4. バックエンドAPIの対応（複数カラムソート）
5. SQLインジェクション対策

### 3.2 ページング機能の実装
**問題点**: 
- 自動スクロール設定が機能していない
- 手動ページング機能がない
- 現在の表示位置が不明

**修正内容**:
1. TableManager設定の反映
2. ページネーションUIの追加
3. ページ遷移機能の実装
4. 重複モードのページング対応
5. ページ情報の表示

### 3.3 UI/UXの改善
**問題点**: ソート可能に見えるが機能しないUI要素

**修正内容**:
1. テーブルヘッダーのソート示唆UI削除
2. カラム幅調整UI削除
3. カーソルポインターの削除
4. 擬似要素の無効化

## 4. データベース構造

### 主要テーブル
- **recepthead**: 受付ヘッダー情報
- **receptbody**: 受付内容データ
- **exechead**: 実行ヘッダー情報
- **execbody**: 実行内容データ
- **m_ctitem**: マスタデータ（ドロップダウン選択肢）
- **m_emp**: 従業員マスタ

### 重要フィールド
- **receptmoddt**: 論理削除フラグ（NOT NULLの場合は削除済み）
- **rdata**: 受付内容
- **execstate**: 対応状況
- **kbn**: 進捗区分

## 5. API仕様

### エンドポイント
- `GET /api/reception-data`: データ取得（ページング、フィルター、ソート対応）
- `GET /api/duplicates/{type}`: 重複検出（exact/content/status）
- `POST /api/delete-duplicates`: 一括論理削除
- `POST /api/restore-duplicates`: 一括復元
- `GET /api/metadata`: マスタデータ取得

### クエリパラメータ
- `offset`: オフセット位置
- `limit`: 取得件数
- `sort_by`: ソートカラム（カンマ区切りで複数指定可）
- `sort_order`: ソート順（カンマ区切りで複数指定可）
- `include_deleted`: 削除済みデータ含む
- 各種フィルター条件

## 6. セキュリティ対策

### SQLインジェクション対策
- ホワイトリスト方式によるカラム名検証
- パラメータ化クエリの使用
- 動的SQL生成時の厳格な検証

### XSS対策
- textContentによるテキスト挿入
- HTMLエスケープ処理

## 7. パフォーマンス最適化

### データベース
- Window関数による効率的な重複検出
- インデックスの活用
- タイムゾーン変換の最適化

### フロントエンド
- 仮想スクロール（自動スクロール機能）
- LocalStorageによる設定キャッシュ
- イベントデリゲーション

## 8. 設定ファイル

### 環境変数（.env）
```
DB_HOST=データベースホスト
DB_NAME=データベース名
DB_USER=ユーザー名
DB_PASSWORD=パスワード
DB_PORT=ポート番号
APP_HOST=アプリケーションホスト
APP_PORT=アプリケーションポート
APP_DEBUG=デバッグモード
```

### 起動方法
```bash
# 推奨
python run.py

# 代替
cd app && python main.py
```

## 9. ブラウザ要件
- モダンブラウザ（Chrome, Firefox, Safari, Edge）
- JavaScript有効
- LocalStorage対応
- CSS Grid/Flexbox対応

## 10. 既知の制限事項
- 重複データは全件メモリに読み込むため、大量データ時は注意が必要
- 論理削除のみ対応（物理削除は不可）
- タイムゾーンは'Asia/Tokyo'固定