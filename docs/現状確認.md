# ソート機能の現状確認

## 概要
テーブル設定ボタンから開くテーブル表示設定ウィンドウで設定したデフォルトソートが、「検索・フィルター実行」および「重複検出実行」時に適用されていない問題を確認しました。

## 1. 現在の構成

### 1.1 フロントエンド構成

#### テーブル設定UI (`index.html:223-234`)
```html
<h4>ソート設定</h4>
<div class="form-group">
    <label for="default-sort-column">デフォルトソート:</label>
    <select id="default-sort-column">
        <!-- 動的に生成される列オプション -->
    </select>
    <select id="default-sort-direction">
        <option value="asc">昇順</option>
        <option value="desc">降順</option>
    </select>
</div>
```

#### テーブルマネージャー (`table-manager.js`)
- ソート設定はLocalStorageに保存される
- デフォルト設定：
  ```javascript
  defaultSort: {
      column: "reception_datetime",
      direction: "desc"
  }
  ```
- 設定の保存と読み込み機能は実装済み

### 1.2 バックエンド構成

#### データ取得API (`api/reception_data.py`)
- `/api/reception-data` エンドポイント
- ソートパラメータを受け付ける：
  - `sort_by`: ソート列（デフォルト: "reception_datetime"）
  - `sort_order`: ソート順（デフォルト: "desc"）

#### 重複検出API (`api/duplicates.py`)
- `/api/duplicates/{type}` エンドポイント
- **ソートパラメータを受け付けない**
- 固定のソート順：`ORDER BY duplicate_key, id`

## 2. 問題の詳細

### 2.1 検索・フィルター実行時の問題

#### 現在の実装 (`app.js:88-99`)
```javascript
async loadData(offset = 0, append = false) {
    const params = new URLSearchParams({
        offset: offset.toString(),
        limit: this.getPageSize().toString(),
        sort_by: "reception_datetime",    // ← ハードコーディング
        sort_order: "desc",                // ← ハードコーディング
        include_deleted: this.includeDeleted.toString(),
        ...this.currentFilters,
    });
    // ...
}
```

**問題点**：
- ソート設定が固定値でハードコーディングされている
- TableManagerの設定を参照していない
- ユーザーが設定したデフォルトソートが無視される

#### 実行フロー
1. ユーザーが「検索・フィルター実行」ボタンをクリック
2. `executeSearch()` → `loadData()` が呼ばれる
3. loadData内で固定のソート値が使用される
4. 設定したソートが反映されない

### 2.2 重複検出実行時の問題

#### 現在の実装 (`duplicate_service.py:89-90`)
```python
ORDER BY duplicate_key, id
```

**問題点**：
- 重複検出APIがソートパラメータを受け付けない
- SQLクエリでソート順が固定されている
- グループごとのソートのみで、グループ内のレコードソートができない

#### 実行フロー
1. ユーザーが「重複検出実行」ボタンをクリック
2. `detectDuplicates()` が呼ばれる
3. `/api/duplicates/{type}` APIが呼ばれる
4. APIレスポンスは固定のソート順で返される
5. フロントエンドでの再ソートも行われない

## 3. 影響範囲

### 影響を受ける機能
1. **検索・フィルター実行**
   - 通常のデータ表示
   - フィルター適用時のデータ表示
   - ページネーション時のデータ表示

2. **重複検出実行**
   - 完全一致検出
   - 受付内容検出
   - 対応状況検出

### 影響を受けないケース
- 初回ページ読み込み時（固定値と同じため偶然動作）
- 列ヘッダークリックによる動的ソート（未実装のため）

## 4. 修正が必要な箇所

### 4.1 フロントエンド修正箇所

1. **app.js の loadData メソッド**
   - TableManagerから現在のソート設定を取得
   - APIパラメータに設定値を適用

2. **app.js の detectDuplicates メソッド**
   - ソート設定をAPIに送信（APIが対応する場合）
   - またはクライアント側でソート実装

### 4.2 バックエンド修正箇所

1. **duplicates.py の detect_duplicates 関数**
   - sort_by, sort_order パラメータを追加
   - DuplicateServiceにソート情報を渡す

2. **duplicate_service.py の detect_duplicates メソッド**
   - ソートパラメータを受け取る
   - SQLクエリのORDER BY句を動的に生成

## 5. データフロー図

### 現在のフロー（問題あり）

```
[ユーザー操作]
    ↓
[テーブル設定でソート設定]
    ↓
[LocalStorageに保存] ← ※ここで止まっている
    
[検索実行/重複検出実行]
    ↓
[固定のソート値でAPI呼び出し] ← ※設定が使われない
    ↓
[固定のソート順でデータ返却]
```

### 期待されるフロー

```
[ユーザー操作]
    ↓
[テーブル設定でソート設定]
    ↓
[LocalStorageに保存]
    ↓
[検索実行/重複検出実行]
    ↓
[設定されたソート値を取得]
    ↓
[設定値でAPI呼び出し]
    ↓
[指定されたソート順でデータ返却]
```

## 6. 結論

現在のシステムでは、ユーザーがテーブル設定で指定したデフォルトソートが実際のデータ取得時に使用されていません。これは以下の2つの主要な問題によるものです：

1. **フロントエンドの問題**：ソート設定がLocalStorageに保存されているが、API呼び出し時に参照されていない
2. **バックエンドの問題**：重複検出APIがソートパラメータをサポートしていない

これらの問題を解決するには、フロントエンドとバックエンドの両方で修正が必要です。