# ソート機能改善 - 修正計画書

## 1. 改善要件

### 1.1 目的
- 検索・フィルター実行時と重複検出実行時にユーザーが設定したソート順を適用する
- それぞれの機能で独立したソート設定を持たせる
- 複数列による優先順位付きソートを実現する

### 1.2 機能要件

#### 検索・フィルター実行用
- 3段階の優先順位でソート設定可能
- 各優先度で列と方向（昇順/降順）を指定

#### 重複検出実行用
- 検出タイプごとに独立したソート設定
- 各タイプで3段階の優先順位設定
- 対応する検出タイプ：
  - 完全一致
  - 受付内容
  - 対応状況

## 2. データ構造設計

### 2.1 LocalStorage保存形式

```javascript
{
  "tableSettings": {
    // 既存の設定
    "columns": {...},
    "pageSize": 100,
    "autoScroll": true,
    
    // 新規追加：検索用ソート設定
    "searchSort": {
      "priority1": {
        "column": "reception_datetime",
        "direction": "desc"
      },
      "priority2": {
        "column": "id",
        "direction": "asc"
      },
      "priority3": {
        "column": null,
        "direction": "asc"
      }
    },
    
    // 新規追加：重複検出用ソート設定
    "duplicateSort": {
      "exact": {
        "priority1": {
          "column": "reception_datetime",
          "direction": "desc"
        },
        "priority2": {
          "column": "content",
          "direction": "asc"
        },
        "priority3": {
          "column": null,
          "direction": "asc"
        }
      },
      "content": {
        "priority1": {
          "column": "reception_datetime",
          "direction": "desc"
        },
        "priority2": {
          "column": "status",
          "direction": "asc"
        },
        "priority3": {
          "column": null,
          "direction": "asc"
        }
      },
      "status": {
        "priority1": {
          "column": "reception_datetime",
          "direction": "desc"
        },
        "priority2": {
          "column": "content",
          "direction": "asc"
        },
        "priority3": {
          "column": null,
          "direction": "asc"
        }
      }
    }
  }
}
```

## 3. UI設計

### 3.1 テーブル設定モーダルの拡張

```html
<!-- 既存のソート設定セクションを置き換え -->
<div class="settings-section">
  <h4>ソート設定</h4>
  
  <!-- タブ切り替え -->
  <div class="sort-tabs">
    <button class="tab-button active" data-tab="search">検索・フィルター用</button>
    <button class="tab-button" data-tab="duplicate">重複検出用</button>
  </div>
  
  <!-- 検索・フィルター用ソート設定 -->
  <div id="search-sort-panel" class="sort-panel active">
    <h5>検索・フィルター実行時のソート</h5>
    
    <div class="sort-priority-group">
      <label>優先度1:</label>
      <select id="search-sort-col-1">
        <option value="">なし</option>
        <option value="id">ID</option>
        <option value="content">受付内容</option>
        <option value="status">対応状況</option>
        <option value="progress">進捗</option>
        <option value="system_type">システム種別</option>
        <option value="product">製品</option>
        <option value="reception_datetime">受付日時</option>
        <option value="update_datetime">更新日時</option>
      </select>
      <select id="search-sort-dir-1">
        <option value="asc">昇順</option>
        <option value="desc">降順</option>
      </select>
    </div>
    
    <div class="sort-priority-group">
      <label>優先度2:</label>
      <select id="search-sort-col-2">
        <!-- 同じオプション -->
      </select>
      <select id="search-sort-dir-2">
        <option value="asc">昇順</option>
        <option value="desc">降順</option>
      </select>
    </div>
    
    <div class="sort-priority-group">
      <label>優先度3:</label>
      <select id="search-sort-col-3">
        <!-- 同じオプション -->
      </select>
      <select id="search-sort-dir-3">
        <option value="asc">昇順</option>
        <option value="desc">降順</option>
      </select>
    </div>
  </div>
  
  <!-- 重複検出用ソート設定 -->
  <div id="duplicate-sort-panel" class="sort-panel" style="display:none;">
    <h5>重複検出実行時のソート</h5>
    
    <!-- 検出タイプ選択 -->
    <div class="duplicate-type-selector">
      <label>検出タイプ:</label>
      <select id="duplicate-sort-type">
        <option value="exact">完全一致</option>
        <option value="content">受付内容</option>
        <option value="status">対応状況</option>
      </select>
    </div>
    
    <!-- 各タイプのソート設定（動的表示） -->
    <div id="duplicate-sort-settings">
      <!-- JavaScript で動的生成 -->
    </div>
  </div>
</div>
```

## 4. フロントエンド修正計画

### 4.1 修正ファイル一覧

1. **app/static/js/table-manager.js**
   - 新しいソート設定構造の実装
   - UI制御ロジックの追加
   - 設定の保存/読み込み処理の拡張

2. **app/static/js/app.js**
   - loadData()メソッドの修正
   - detectDuplicates()メソッドの修正
   - ソート設定の取得処理追加

3. **app/templates/index.html**
   - テーブル設定モーダルのUI拡張

4. **app/static/css/style.css**
   - 新しいUIコンポーネントのスタイル追加

### 4.2 主要な修正内容

#### table-manager.js の修正

```javascript
class TableManager {
  constructor(app) {
    this.app = app;
    this.settings = this.loadSettings();
    this.defaultSettings = {
      // 既存の設定...
      
      // 新規追加
      searchSort: {
        priority1: { column: 'reception_datetime', direction: 'desc' },
        priority2: { column: null, direction: 'asc' },
        priority3: { column: null, direction: 'asc' }
      },
      duplicateSort: {
        exact: {
          priority1: { column: 'reception_datetime', direction: 'desc' },
          priority2: { column: null, direction: 'asc' },
          priority3: { column: null, direction: 'asc' }
        },
        content: {
          priority1: { column: 'reception_datetime', direction: 'desc' },
          priority2: { column: null, direction: 'asc' },
          priority3: { column: null, direction: 'asc' }
        },
        status: {
          priority1: { column: 'reception_datetime', direction: 'desc' },
          priority2: { column: null, direction: 'asc' },
          priority3: { column: null, direction: 'asc' }
        }
      }
    };
  }
  
  // 検索用ソート設定を取得
  getSearchSortParams() {
    const sort = this.settings.searchSort;
    const columns = [];
    const directions = [];
    
    for (let i = 1; i <= 3; i++) {
      const priority = sort[`priority${i}`];
      if (priority && priority.column) {
        columns.push(priority.column);
        directions.push(priority.direction);
      }
    }
    
    return {
      sort_by: columns.join(','),
      sort_order: directions.join(',')
    };
  }
  
  // 重複検出用ソート設定を取得
  getDuplicateSortParams(duplicateType) {
    const sort = this.settings.duplicateSort[duplicateType];
    const columns = [];
    const directions = [];
    
    for (let i = 1; i <= 3; i++) {
      const priority = sort[`priority${i}`];
      if (priority && priority.column) {
        columns.push(priority.column);
        directions.push(priority.direction);
      }
    }
    
    return {
      sort_by: columns.join(','),
      sort_order: directions.join(',')
    };
  }
}
```

#### app.js の修正

```javascript
async loadData(offset = 0, append = false) {
  try {
    this.showLoading(true);
    
    // TableManagerからソート設定を取得
    const sortParams = this.tableManager.getSearchSortParams();
    
    const params = new URLSearchParams({
      offset: offset.toString(),
      limit: this.getPageSize().toString(),
      sort_by: sortParams.sort_by || "reception_datetime",
      sort_order: sortParams.sort_order || "desc",
      include_deleted: this.includeDeleted.toString(),
      ...this.currentFilters,
    });
    
    // 以下既存の処理...
  }
}

async detectDuplicates() {
  const duplicateType = document.getElementById("duplicate-type-select").value;
  const filters = this.getAllFilters();
  
  // TableManagerからソート設定を取得
  const sortParams = this.tableManager.getDuplicateSortParams(duplicateType);
  
  try {
    this.showLoading(true);
    
    const allFilters = {
      ...filters,
      include_deleted: this.includeDeleted,
      ...sortParams  // ソートパラメータを追加
    };
    
    // 以下既存の処理...
  }
}
```

## 5. バックエンド修正計画

### 5.1 修正ファイル一覧

1. **app/api/duplicates.py**
   - ソートパラメータの追加
   
2. **app/services/duplicate_service.py**
   - 複数列ソート対応
   - 動的ORDER BY句の生成

3. **app/services/data_service.py**
   - 複数列ソート対応（既存の拡張）

### 5.2 主要な修正内容

#### duplicates.py の修正

```python
@router.get("/duplicates/{duplicate_type}", response_model=DuplicatesResponse)
async def detect_duplicates(
    duplicate_type: str = Path(..., regex="^(exact|content|status)$"),
    # 新規追加パラメータ
    sort_by: Optional[str] = Query(None, description="ソート列（カンマ区切り）"),
    sort_order: Optional[str] = Query(None, description="ソート順（カンマ区切り）"),
    # 既存のパラメータ...
):
    """重複データ検出API"""
    try:
        # ソート設定の解析
        sort_columns = sort_by.split(',') if sort_by else []
        sort_orders = sort_order.split(',') if sort_order else []
        
        # 重複検出（ソート情報を渡す）
        duplicate_groups = DuplicateService.detect_duplicates(
            duplicate_type, 
            filters,
            sort_columns=sort_columns,
            sort_orders=sort_orders
        )
        
        # 以下既存の処理...
```

#### duplicate_service.py の修正

```python
@staticmethod
def detect_duplicates(
    duplicate_type: str,
    filters: Optional[FilterRequest] = None,
    sort_columns: List[str] = None,
    sort_orders: List[str] = None
) -> List[DuplicateGroup]:
    """重複データ検出"""
    
    # ORDER BY句の動的生成
    order_by_clause = DuplicateService.build_order_by_clause(
        sort_columns, 
        sort_orders,
        default="duplicate_key, id"
    )
    
    query = f"""
    WITH duplicates AS (
        -- 既存のクエリ...
        ROW_NUMBER() OVER (
            PARTITION BY {partition_by}
            ORDER BY {DuplicateService.build_window_order_by(sort_columns, sort_orders)}
        ) as row_num,
        -- 以下既存の処理...
    )
    SELECT
        -- 既存のSELECT...
    FROM duplicates
    WHERE duplicate_count > 1
    ORDER BY {order_by_clause}
    """
    
@staticmethod
def build_order_by_clause(columns: List[str], orders: List[str], default: str) -> str:
    """ORDER BY句を動的に生成"""
    if not columns:
        return default
    
    order_parts = []
    for i, column in enumerate(columns):
        direction = orders[i] if i < len(orders) else "ASC"
        # カラムマッピング（SQLインジェクション対策）
        column_map = {
            "id": "id",
            "content": "content",
            "status": "status",
            "progress": "progress",
            "system_type": "system_type",
            "product": "product",
            "reception_datetime": "reception_datetime",
            "update_datetime": "update_datetime"
        }
        
        if column in column_map:
            order_parts.append(f"{column_map[column]} {direction.upper()}")
    
    # グループ化のためduplicate_keyを最優先に
    return f"duplicate_key, {', '.join(order_parts)}" if order_parts else default
```

#### data_service.py の修正

```python
@staticmethod
def get_reception_data(
    offset: int = 0,
    limit: int = 100,
    sort_by: str = "reception_datetime",
    sort_order: str = "desc",
    filters: Optional[FilterRequest] = None
) -> Tuple[List[ReceptionDataRecord], int]:
    """受信データ取得（複数列ソート対応）"""
    
    # 複数列ソートの解析
    sort_columns = sort_by.split(',') if ',' in sort_by else [sort_by]
    sort_orders = sort_order.split(',') if ',' in sort_order else [sort_order]
    
    # ORDER BY句の構築
    order_by_parts = []
    column_map = {
        "id": "recepthead.extentid",
        "content": "receptbody.rdata",
        "status": "COALESCE(execbody.execstate, '')",
        "progress": "cond_item.itemname",
        "system_type": "stype_item.itemname",
        "product": "prod_item.itemname",
        "reception_datetime": "recepthead.calldt",
        "update_datetime": "COALESCE(receptbody.moddt, recepthead.calldt)"
    }
    
    for i, column in enumerate(sort_columns):
        if column in column_map:
            direction = sort_orders[i] if i < len(sort_orders) else "ASC"
            order_by_parts.append(f"{column_map[column]} {direction.upper()}")
    
    order_by_clause = ", ".join(order_by_parts) if order_by_parts else "recepthead.calldt DESC"
    
    # データ取得クエリ
    data_query = f"""
    -- 既存のSELECT...
    ORDER BY {order_by_clause}
    LIMIT %s OFFSET %s
    """
```

## 6. 実装スケジュール

### Phase 1: フロントエンド基盤（優先度：高）
1. **table-manager.js の拡張**
   - 新しいデータ構造の実装
   - ソートパラメータ取得メソッドの追加
   
2. **app.js の修正**
   - loadDataメソッドの修正
   - detectDuplicatesメソッドの修正

### Phase 2: UI実装（優先度：中）
3. **index.html の修正**
   - テーブル設定モーダルの拡張
   
4. **style.css の更新**
   - 新UIコンポーネントのスタイリング

### Phase 3: バックエンド対応（優先度：高）
5. **data_service.py の修正**
   - 複数列ソート対応
   
6. **duplicates.py / duplicate_service.py の修正**
   - ソートパラメータ対応
   - 動的ORDER BY句の実装

### Phase 4: テスト・調整（優先度：低）
7. **動作確認**
   - 各種ソートパターンのテスト
   - エッジケースの確認
   
8. **微調整**
   - パフォーマンス最適化
   - UI/UXの改善

## 7. 注意事項

### セキュリティ
- SQLインジェクション対策として、ソート列名はホワイトリスト方式で検証
- ユーザー入力を直接SQLに組み込まない

### パフォーマンス
- 複数列ソートによるクエリ性能への影響を監視
- 必要に応じてインデックスの追加を検討

### 互換性
- 既存の設定との後方互換性を維持
- デフォルト値により既存ユーザーへの影響を最小化

### ユーザビリティ
- 複雑な設定画面にならないよう、UIをシンプルに保つ
- プリセット機能の追加も検討

## 8. 期待される効果

1. **柔軟なデータ表示**
   - ユーザーのニーズに応じた多様なソート表示が可能

2. **作業効率の向上**
   - 用途別のソート設定により、データ分析が効率化

3. **ユーザー満足度の向上**
   - きめ細かい設定により、各ユーザーの業務に最適化

## 9. 今後の拡張案

- ソート設定のプリセット機能
- ソート設定のエクスポート/インポート
- グループ内でのソート設定（重複検出時）
- 動的なソート変更（列ヘッダークリック）