# 要件定義書：削除データ表示制御と復元機能

## 1. プロジェクト概要

### 1.1 背景
現在の重複データ管理システムでは、以下の課題が存在します：
- 削除済みデータと未削除データが混在して表示される
- レコード数表示が削除状況を考慮していない
- 削除済みデータの復元機能がない
- 効率的なデータ整理ワークフローが確立されていない

### 1.2 目的
削除済みデータの表示制御機能と復元機能を追加することで、より効率的なデータ管理ワークフローを実現する。

## 2. 機能要件

### 2.1 レコード数表示の改善

#### 2.1.1 現状
```
全レコード (155,081件)
```

#### 2.1.2 改善後
```
全レコード: 155,081件 (有効: 142,356件 / 削除済み: 12,725件)
```

**詳細:**
- 2015年1月1日以降の全データ数
- 削除済み（`receptmoddt IS NOT NULL`）を除いた有効データ数
- 削除済みデータ数
- 現在の表示フィルター適用後の件数

### 2.2 削除済みデータ表示制御

#### 2.2.1 チェックボックス追加
- **表示位置**: フィルターセクション
- **ラベル**: 「削除済みデータを表示する」
- **デフォルト状態**: 未チェック（削除済み非表示）

#### 2.2.2 動作仕様
- **チェック時**: 削除済みデータも含めて表示
- **未チェック時**: 削除済みデータを除外（`receptmoddt IS NULL`条件追加）
- **重複検出**: チェック状態に関わらず、削除済みは対象外

### 2.3 データ状態表示の改善

#### 2.3.1 テーブル表示
- **削除フラグ日時列**: 削除済みの場合は日時表示、未削除の場合は空白
- **行スタイル**: 削除済みデータは薄いグレー背景で表示

#### 2.3.2 ステータス表示
```
表示中: 1,250件 (有効: 1,180件 / 削除済み: 70件)
選択中: 15件 (有効: 12件 / 削除済み: 3件)
```

### 2.4 復元機能

#### 2.4.1 復元操作
- **対象**: 削除済みデータのみ
- **操作**: 選択した削除済みデータの`receptmoddt`をNULLに設定
- **確認**: 復元前に確認ダイアログ表示

#### 2.4.2 UI変更
- **削除ボタン**: 未削除データ選択時のみ有効
- **復元ボタン**: 削除済みデータ選択時のみ有効
- **ボタン表示**: 選択データの状態に応じて動的表示

## 3. 運用フロー要件

### 3.1 基本的な整理フロー
```
①削除済み非表示状態（デフォルト）
↓
②重複データ検出
↓
③フィルターで絞り込み
↓  
④不要データをチェック・削除
↓
①に戻る（クリーンな状態）
```

### 3.2 復元フロー
```
①「削除済みデータを表示」をチェック
↓
②復元対象を検索・絞り込み
↓
③復元対象をチェック・復元実行
↓
④「削除済みデータを表示」のチェックを外す
↓
基本フローに戻る
```

## 4. 非機能要件

### 4.1 パフォーマンス
- **レスポンス時間**: 削除状態フィルター適用でも2秒以内
- **データ量**: 削除済みデータ表示でもスクロール性能維持

### 4.2 ユーザビリティ
- **デフォルト状態**: 削除済み非表示で運用効率を優先
- **操作の明確性**: 削除/復元ボタンの表示を選択状態で切り替え
- **視覚的識別**: 削除済みデータの視覚的区別

### 4.3 データ整合性
- **削除**: `receptmoddt`に削除日時設定（論理削除維持）
- **復元**: `receptmoddt`をNULLに設定
- **重複検出**: 削除済みデータは検出対象外を維持

## 5. 制約事項

### 5.1 技術的制約
- **データベース構造**: 既存の論理削除仕組み（`receptmoddt`）を維持
- **API互換性**: 既存APIの後方互換性を保持
- **フロントエンド**: バニラJS実装を継続

### 5.2 業務的制約
- **権限**: 削除・復元操作に特別な権限は不要（現状維持）
- **ログ**: 復元操作のログ記録は現段階では対象外

## 6. 受け入れ条件

### 6.1 機能受け入れ条件
- [ ] 削除済みデータ表示のON/OFF切り替えが正常動作する
- [ ] レコード数表示が有効/削除済み件数を正しく表示する
- [ ] 復元機能が選択したデータを正常に復元する
- [ ] 削除/復元ボタンが選択データの状態に応じて適切に表示される
- [ ] 削除済みデータが視覚的に識別できる

### 6.2 運用受け入れ条件
- [ ] デフォルト状態（削除済み非表示）でスムーズにデータ整理できる
- [ ] 重複検出で削除済みデータが対象外になる
- [ ] 復元操作が必要時に容易に実行できる

### 6.3 性能受け入れ条件
- [ ] 削除済みフィルター適用時のレスポンス時間が2秒以内
- [ ] 大量の削除済みデータ表示時もスクロール性能が維持される

## 7. 影響範囲

### 7.1 修正対象ファイル
#### バックエンド
- `app/services/data_service.py`: データ取得ロジック修正
- `app/services/delete_service.py`: 復元機能追加
- `app/api/operations.py`: 復元API追加
- `app/models/request_models.py`: リクエストモデル拡張
- `app/models/response_models.py`: レスポンスモデル拡張

#### フロントエンド
- `app/templates/index.html`: UI要素追加
- `app/static/js/app.js`: 削除済み制御ロジック追加
- `app/static/js/delete-manager.js`: 復元機能追加
- `app/static/css/style.css`: 削除済みデータ表示スタイル

### 7.2 新規追加ファイル
- `app/services/restore_service.py`: 復元サービス（必要に応じて）

## 8. リスク分析

### 8.1 技術的リスク
- **クエリパフォーマンス**: 削除済みフィルター追加による性能劣化
- **UI複雑化**: 削除/復元操作の切り替えによる操作性低下

### 8.2 運用的リスク  
- **操作ミス**: 復元機能による意図しないデータ復活
- **ワークフロー混乱**: 新しい操作手順への習熟期間

### 8.3 対策
- **性能対策**: 適切なインデックス確認、クエリ最適化
- **UI設計**: 明確な状態表示、確認ダイアログの実装
- **ドキュメント**: 新しい運用フローの説明書作成