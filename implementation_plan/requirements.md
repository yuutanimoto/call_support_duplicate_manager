# ログ出力機能 - 要件定義書

## 1. 概要

重複データ管理システムにおいて、削除・復元操作のログ出力機能を追加する。
操作履歴を追跡可能にし、システムの透明性と監査性を向上させる。

## 2. 機能要件

### 2.1 ログ出力対象
- **削除操作**: どのextentid（ID）が削除されたか
- **復元操作**: どのextentid（ID）が復元されたか
- **操作タイムスタンプ**: 操作実行日時
- **操作結果**: 成功・失敗の情報

### 2.2 ログ出力内容
以下の情報をログに記録する：

#### 削除操作ログ
```
[DELETE] 2025-08-08 14:30:15 - SUCCESS: Deleted extentids: [12345, 67890, 11111] (3 records)
[DELETE] 2025-08-08 14:31:20 - ERROR: Failed to delete extentids: [22222] - Database connection error
```

#### 復元操作ログ
```
[RESTORE] 2025-08-08 14:32:30 - SUCCESS: Restored extentids: [12345, 67890] (2 records)
[RESTORE] 2025-08-08 14:33:15 - ERROR: Failed to restore extentids: [33333] - Record not found
```

### 2.3 ログファイル要件

#### ファイル名形式
- `operation.log` (現在のアクティブログファイル)
- `operation.log.1` (第1世代バックアップ)
- `operation.log.2` (第2世代バックアップ)

#### ローテーション設定
- **最大ファイルサイズ**: 10MB
- **保持世代数**: 3ファイル
- **ローテーション方式**: サイズベース
- **圧縮**: なし（プレーンテキスト）

#### 出力場所
- `logs/` ディレクトリ配下
- アプリケーションルートからの相対パス

## 3. 技術要件

### 3.1 ログレベル
- INFO: 正常な操作
- ERROR: エラーが発生した操作
- DEBUG: デバッグ情報（開発時のみ）

### 3.2 文字エンコーディング
- UTF-8

### 3.3 タイムゾーン
- Asia/Tokyo（既存システムと統一）

### 3.4 パフォーマンス要件
- ログ出力によるAPIレスポンス時間の劣化: 50ms以内
- 非同期ログ出力の検討

## 4. 非機能要件

### 4.1 信頼性
- ログファイルの書き込みエラーがメイン処理に影響しないこと
- ディスク容量不足時のエラーハンドリング

### 4.2 保守性
- ログ設定の外部化（環境変数またはコンフィグファイル）
- ログレベルの動的変更機能

### 4.3 セキュリティ
- 個人情報や機密情報をログに含めないこと
- ログファイルのアクセス権限設定

## 5. 制約事項

### 5.1 現行システムへの影響
- 既存のAPIインターフェースは変更しない
- 既存のデータベーススキーマは変更しない
- 既存の処理ロジックへの最小限の影響

### 5.2 運用制約
- ログディレクトリの作成・権限設定は手動で実施
- ログファイルの監視・アラートは別途検討

## 6. 受け入れ条件

### 6.1 機能テスト
- [ ] 削除操作時にextentidが正しくログ出力される
- [ ] 復元操作時にextentidが正しくログ出力される
- [ ] ファイルサイズが10MBに達したときにローテーションが発生する
- [ ] 3世代を超えた古いログファイルが削除される

### 6.2 異常系テスト
- [ ] ログディレクトリが存在しない場合のエラーハンドリング
- [ ] ディスク容量不足時のエラーハンドリング
- [ ] 権限不足でログファイルに書き込めない場合のエラーハンドリング

### 6.3 パフォーマンステスト
- [ ] ログ出力によるレスポンス時間の影響が50ms以内
- [ ] 大量データ削除時のログ出力性能

## 7. 今後の拡張検討事項

- 操作ユーザーの記録（認証機能実装後）
- 操作理由・コメントの記録
- ログ検索・フィルタリング機能
- ログのデータベース格納
- リアルタイム監視・アラート機能